<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Weekly Update - {{ demand.name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .demand-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .demand-info h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }

        .demand-info p {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Edit Weekly Update</h1>

        <div class="demand-info">
            <h3>Demand Information</h3>
            <p><strong>Demand:</strong> {{ demand.name }}</p>
            <p><strong>Week:</strong> {{ weekly_update.week_number }}</p>
            <p><strong>Current Stage:</strong> {{ weekly_update.get_current_stage_display|default:"Not set" }}</p>
            {% if demand.start_date and demand.get_end_date %}
            <div style="background-color: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #2196f3;">
                <p style="margin: 0; font-weight: 500; color: #1976d2;">
                    ðŸ“… <strong>Demand Duration:</strong> {{ demand.start_date|date:"M d, Y" }} to {{ demand.get_end_date|date:"M d, Y" }}
                </p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                    Weekly updates can only be created within this date range.
                </p>
            </div>
            {% endif %}
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.week_number.id_for_label }}">Week Number:</label>
                    {{ form.week_number }}
                    {% if form.week_number.errors %}
                    <div class="error-message">{{ form.week_number.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.current_stage.id_for_label }}">Current Stage:</label>
                    {{ form.current_stage }}
                    {% if form.current_stage.errors %}
                    <div class="error-message">{{ form.current_stage.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.week_start_date.id_for_label }}">Week Start Date:</label>
                    {{ form.week_start_date }}
                    {% if form.week_start_date.errors %}
                    <div class="error-message">{{ form.week_start_date.errors.0 }}</div>
                    {% endif %}
                    {% if form.week_start_date.help_text %}
                    <div class="help-text">{{ form.week_start_date.help_text }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.week_end_date.id_for_label }}">Week End Date:</label>
                    {{ form.week_end_date }}
                    {% if form.week_end_date.errors %}
                    <div class="error-message">{{ form.week_end_date.errors.0 }}</div>
                    {% endif %}
                    {% if form.week_end_date.help_text %}
                    <div class="help-text">{{ form.week_end_date.help_text }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- <div class="form-group">
                <button type="button" id="auto-calculate-week"
                    style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    ðŸ“… Auto-calculate Week Dates
                </button>
                <div class="help-text" style="margin-top: 5px;">Click to automatically calculate week dates based on the
                    week number</div>
            </div> -->

            <div class="form-group">
                <label for="{{ form.achievements.id_for_label }}">Achievements:</label>
                {{ form.achievements }}
                {% if form.achievements.errors %}
                <div class="error-message">{{ form.achievements.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.challenges.id_for_label }}">Challenges:</label>
                {{ form.challenges }}
                {% if form.challenges.errors %}
                <div class="error-message">{{ form.challenges.errors.0 }}</div>
                {% endif %}
            </div>

            <div style="margin-top: 30px;">
                <button type="submit" class="btn btn-primary">Update Weekly Update</button>
                <a href="{% url 'weekly_history' demand_id=demand.id %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const weekNumberInput = document.getElementById('{{ form.week_number.id_for_label }}');
            const startDateInput = document.getElementById('{{ form.week_start_date.id_for_label }}');
            const endDateInput = document.getElementById('{{ form.week_end_date.id_for_label }}');
            const autoCalculateBtn = document.getElementById('auto-calculate-week');

            // Auto-calculate week dates based on week number
            autoCalculateBtn.addEventListener('click', function () {
                const weekNumber = parseInt(weekNumberInput.value);
                if (!weekNumber || weekNumber < 1) {
                    alert('Please enter a valid week number first');
                    return;
                }

                // Calculate dates based on current year and week number
                const currentYear = new Date().getFullYear();
                const startOfYear = new Date(currentYear, 0, 1);
                const daysToAdd = (weekNumber - 1) * 7;

                // Find the first Monday of the year
                const firstMonday = new Date(startOfYear);
                const dayOfWeek = startOfYear.getDay();
                const daysToMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek);
                firstMonday.setDate(startOfYear.getDate() + daysToMonday);

                // Calculate week start (Monday) and end (Sunday)
                const weekStart = new Date(firstMonday);
                weekStart.setDate(firstMonday.getDate() + daysToAdd);

                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                // Format dates for input fields (YYYY-MM-DD)
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                startDateInput.value = formatDate(weekStart);
                endDateInput.value = formatDate(weekEnd);

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.color = '#28a745';
                successMsg.style.fontSize = '12px';
                successMsg.style.marginTop = '5px';
                successMsg.textContent = `Week ${weekNumber} dates calculated: ${formatDate(weekStart)} to ${formatDate(weekEnd)}`;

                // Remove any existing success message
                const existingMsg = autoCalculateBtn.parentNode.querySelector('.success-message');
                if (existingMsg) {
                    existingMsg.remove();
                }

                successMsg.className = 'success-message';
                autoCalculateBtn.parentNode.appendChild(successMsg);
            });

            // Auto-fill end date when start date changes (add 6 days)
            startDateInput.addEventListener('change', function () {
                if (startDateInput.value && !endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);

                    const formatDate = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    // Check if the calculated end date exceeds the demand end date
                    const demandEndDate = startDateInput.getAttribute('data-demand-end');
                    if (demandEndDate) {
                        const demandEnd = new Date(demandEndDate);
                        if (endDate > demandEnd) {
                            // Adjust end date to demand end date
                            endDate.setTime(demandEnd.getTime());
                        }
                    }

                    endDateInput.value = formatDate(endDate);
                }
            });

            // Validate that end date is not before start date and within demand duration
            endDateInput.addEventListener('change', function () {
                if (startDateInput.value && endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);

                    if (endDate < startDate) {
                        alert('End date cannot be before start date');
                        endDateInput.value = '';
                        return;
                    }

                    // Check if dates are within demand duration
                    const demandStartDate = startDateInput.getAttribute('data-demand-start');
                    const demandEndDate = startDateInput.getAttribute('data-demand-end');
                    
                    if (demandStartDate && demandEndDate) {
                        const demandStart = new Date(demandStartDate);
                        const demandEnd = new Date(demandEndDate);
                        
                        if (startDate < demandStart || startDate > demandEnd) {
                            alert('Start date must be within the demand duration period');
                            startDateInput.value = '';
                            return;
                        }
                        
                        if (endDate < demandStart || endDate > demandEnd) {
                            alert('End date must be within the demand duration period');
                            endDateInput.value = '';
                            return;
                        }
                    }
                }
            });

            // Validate start date is within demand duration
            startDateInput.addEventListener('change', function () {
                if (startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const demandStartDate = startDateInput.getAttribute('data-demand-start');
                    const demandEndDate = startDateInput.getAttribute('data-demand-end');
                    
                    if (demandStartDate && demandEndDate) {
                        const demandStart = new Date(demandStartDate);
                        const demandEnd = new Date(demandEndDate);
                        
                        if (startDate < demandStart || startDate > demandEnd) {
                            alert('Start date must be within the demand duration period');
                            startDateInput.value = '';
                            return;
                        }
                    }
                }
            });
        });
    </script>
</body>

</html>